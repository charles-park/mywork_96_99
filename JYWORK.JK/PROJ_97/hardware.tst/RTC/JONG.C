#include <io51.h>
#include <stdlib.h>
#include <stdio.h>
/* #include <def.h> */

#define read_XDATA(address)      (((char *)0x010000)[address])
#define read_CODE(address)      (((char *)0x020000)[address])

#define output(address,value)      (((char *)0x010000)[address]=value)
/* #define write_XDATA(address,value)      (((char *)0x010000)[address]=value) */

#define cs0 0x0000
#define cs1 0x2000 /* 82c55 port */
#define cs2 0x4000 /* ad7828 port */
#define cs3 0x6000 /* ram port */
#define cs4 0x8000 /* char port */
#define cs5 0xa000
#define cs6 0xc000
#define cs7 0xe000
#define font_addr(c_addr,val)  (((char *)0x010000)[c_addr]=val)
#define ad_read(x)  (((char *) 0x014000)[x])
#define ad7828 0x4000
#define P8255_mode 0x2000
#define P8255_porta 0x2001
#define P8255_portb 0x2002
#define P8255_portc 0x2003

#define ENB 0x9000

void init_cpu();
void ad_init();
void ad_cmp();
char range(char);

void ch_out(char font,char loct);
void font_test();

#pragma memory=data

char ad_buff[8];

#pragma memory=default



char FONT_DATA[26][8][8]={   /* 'a' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,1,1,1,0,0,0,0,
                1,0,0,1,0,0,0,0,
                1,0,0,1,0,0,0,0,
                1,0,0,1,0,0,0,0,
                0,1,1,0,1,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'b' */
                1,0,0,0,0,0,0,0,
                1,0,0,0,0,0,0,0,
                1,0,1,1,0,0,0,0,
                1,1,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,1,1,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'c' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,1,1,1,0,0,0,0,
                1,0,0,0,0,0,0,0,
                1,0,0,0,0,0,0,0,
                1,0,0,0,1,0,0,0,
                0,1,1,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'd' */
                0,0,0,0,1,0,0,0,
                0,0,0,0,1,0,0,0,
                0,1,1,0,1,0,0,0,
                1,0,0,1,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                0,1,1,1,1,0,0,0,
                0,0,0,0,0,0,0,0,
/* 'e' */

                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,1,1,1,0,0,0,0,
                1,0,0,0,1,0,0,0,
                1,1,1,1,1,0,0,0,
                1,0,0,0,0,0,0,0,
                0,1,1,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'f' */
                0,0,1,0,0,0,0,0,
                0,1,0,1,0,0,0,0,
                0,1,0,0,0,0,0,0,
                1,1,1,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'g' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,1,1,1,1,0,0,0,
                1,0,0,0,1,0,0,0,
                0,1,1,1,1,0,0,0,
                0,0,0,0,1,0,0,0,
                0,1,1,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'h' */
                1,0,0,0,0,0,0,0,
                1,0,0,0,0,0,0,0,
                1,1,1,0,0,0,0,0,
                1,0,0,1,0,0,0,0,
                1,0,0,1,0,0,0,0,
                1,0,0,1,0,0,0,0,
                1,0,0,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'i' */
                0,1,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                1,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                1,1,1,0,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'j' */
                0,0,0,1,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,0,1,1,0,0,0,0,
                0,0,0,1,0,0,0,0,
                0,0,0,1,0,0,0,0,
                1,0,0,1,0,0,0,0,
                0,1,1,0,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'k' */
                1,0,0,0,0,0,0,0,
                1,0,0,0,0,0,0,0,
                1,0,0,1,0,0,0,0,
                1,0,1,0,0,0,0,0,
                1,1,0,0,0,0,0,0,
                1,0,1,0,0,0,0,0,
                1,0,0,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'l' */
                1,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                1,1,1,0,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'm' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,1,0,1,0,0,0,0,
                1,0,1,0,1,0,0,0,
                1,0,1,0,1,0,0,0,
                1,0,1,0,1,0,0,0,
                1,0,1,0,1,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'n' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                1,0,1,1,0,0,0,0,
                1,1,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'o' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,1,1,1,0,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                0,1,1,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'p' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                1,1,1,1,0,0,0,0,
                1,0,0,0,1,0,0,0,
                1,1,1,1,0,0,0,0,
                1,0,0,0,0,0,0,0,
                1,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'q' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,1,1,1,0,0,0,0,
                1,0,0,1,0,0,0,0,
                0,1,1,1,0,0,0,0,
                0,0,0,1,0,0,0,0,
                0,0,0,1,1,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'r' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                1,0,1,1,0,0,0,0,
                1,1,0,0,0,0,0,0,
                1,0,0,0,0,0,0,0,
                1,0,0,0,0,0,0,0,
                1,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 's' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                0,1,1,1,0,0,0,0,
                1,0,0,0,0,0,0,0,
                0,1,1,1,0,0,0,0,
                0,0,0,0,1,0,0,0,
                1,1,1,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 't' */
                0,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                1,1,1,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                0,1,0,1,0,0,0,0,
                0,0,1,0,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'u' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,1,1,0,0,0,
                0,1,1,0,1,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'v' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                0,1,0,1,0,0,0,0,
                0,0,1,0,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'w' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,1,0,1,0,0,0,
                1,0,1,0,1,0,0,0,
                0,1,0,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'x' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                1,1,1,0,1,0,0,0,
                0,0,1,1,0,0,0,0,
                0,0,1,0,0,0,0,0,
                0,1,1,0,0,0,0,0,
                1,0,1,1,1,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'y' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                1,0,0,0,1,0,0,0,
                1,0,0,0,1,0,0,0,
                0,1,1,1,1,0,0,0,
                0,0,0,0,1,0,0,0,
                0,1,1,1,0,0,0,0,
                0,0,0,0,0,0,0,0,

/* 'z' */
                0,0,0,0,0,0,0,0,
                0,0,0,0,0,0,0,0,
                1,1,1,1,1,0,0,0,
                0,0,0,1,0,0,0,0,
                0,0,1,0,0,0,0,0,
                0,1,0,0,0,0,0,0,
                1,1,1,1,1,0,0,0,
                0,0,0,0,0,0,0,0
              

};


void main()
{
   init_cpu();
   ad_init();
   ad_cmp();

   font_test();
}

void font_test()
{
    /* char *ptr[]; */
    char *ptr;
    char point=0,i;
    for(i=0;i<26;i++)
    {
        ptr = &FONT_DATA[0][0][0];
        ch_out(*ptr,point);
        point++;
    }
}


void init_cpu()
{
   SCON = 0x50;
   TMOD = 0x31;
   TCON = 0x55;
   TH0 = 0xdc;
   TL0 = 0x00;
   IE = 0x00;
   IP = 0x02;
   /* 8255_mode = */
}

void ad_init()
{
   char i;
   for(i=0;i<8;i++)  ad_buff[i] = 0;
}

char range(char i)
{
   if(i>=0 | i<= 30)        return 0;
   else if(i>=31 | i<=60)   return 1;
   else if(i>=61 | i<=90)   return 2;
   else if(i>=91 | i<=120)  return 3;
   else if(i>=121 | i<=150) return 4;
   else if(i>=151 | i<=180) return 5;
   else if(i>=181 | i<=210) return 6;
   /* else if(i>=211 | i<=240) return 7; */
   else return 7;
}

void ad_cmp()
{
   unsigned char ad_value,comp,i;
   
   for(i=0;i<8;i++)
   {
      ad_value = ad_read(i);
      comp = range(ad_value);
      if (comp != ad_buff[i])         ad_buff[i] = comp;
   }
}

/* ch_out(msg[1],center) */


void ch_out(char font, char loct)
{
    char v_h=0;
    int addr=cs4;
    while(1)
    {
        if(font == 1){
            output(addr,font);
            output(ENB,1);
            output(ENB,0);
        }

        font++;
        addr++;
        if(v_h == 80)   break;
    }
}



